<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corah • Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">
  <style>
    /* mobile-safe scroll padding for the fixed input bar */
    .chat-scroll { scroll-padding-bottom: 8rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b bg-white sticky top-0 z-10">
      <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-xl bg-indigo-600"></div>
          <div>
            <h1 class="font-semibold leading-tight">Corah</h1>
            <p class="text-xs text-slate-500">Corvox’s friendly front-desk assistant - Owner: Nasir Bashir</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="newChatBtn" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-slate-50">New chat</button>
          <button id="copyLinkBtn" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-slate-50">Copy share link</button>
        </div>
      </div>
    </header>

    <!-- Chat timeline -->
    <main id="chat" class="flex-1 max-w-3xl mx-auto w-full px-4 pt-4 pb-40 chat-scroll overflow-y-auto">
      <!-- Assistant warm opener -->
      <div class="flex gap-3 mb-4">
        <div class="h-8 w-8 rounded-xl bg-indigo-600 flex-shrink-0"></div>
        <div class="bg-white border rounded-2xl px-4 py-3 shadow-sm max-w-[85%]">
          <p class="whitespace-pre-wrap">Hello! How can I help today?</p>
        </div>
      </div>
      <!-- Inactivity / close banners will be appended here -->
    </main>

    <!-- Composer -->
    <div class="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur border-t">
      <div class="max-w-3xl mx-auto px-4 py-3">
        <form id="composer" class="flex items-end gap-2">
          <textarea id="input" rows="1" placeholder="Type a message… (Shift+Enter = newline)"
            class="flex-1 resize-none rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            autocomplete="off"></textarea>
          <button id="sendBtn" type="submit"
            class="shrink-0 rounded-xl bg-indigo-600 text-white px-4 py-3 font-medium hover:bg-indigo-700 disabled:opacity-50">
            Send
          </button>
        </form>
        <p id="status" class="mt-2 text-xs text-slate-500"></p>
      </div>
    </div>
  </div>

  <script>
    // -------- Config --------
    // Use same-origin by default. You can override with ?api=https://your-server:8000
    const urlParams = new URLSearchParams(location.search);
    const API_BASE = (urlParams.get('api') || 'http://ec2-44-208-12-236.compute-1.amazonaws.com:8000/api').replace(/\/+$/, '');
    const HEALTH_URL = API_BASE + '/health';
    const CHAT_URL = API_BASE + '/chat';
    const PING_URL = API_BASE + '/ping';

    // Inactivity knobs (mirror server; warn ~1 minute before close)
    const INACTIVITY_MINUTES = 5;
    const FRONTEND_WARN_AT_MIN = Math.max(1, INACTIVITY_MINUTES - 1);

    // Keep one session per browser tab unless "New chat"
    let sessionId = localStorage.getItem('corah_session_id');
    if (!sessionId) {
      const rand = (window.crypto && typeof window.crypto.randomUUID === 'function')
        ? window.crypto.randomUUID().slice(0, 8)
        : (Date.now().toString(36) + Math.random().toString(36).slice(2, 10)).slice(0, 8);
      sessionId = 'web-' + rand;
      localStorage.setItem('corah_session_id', sessionId);
    }

    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const composerEl = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');
    const statusEl = document.getElementById('status');
    const newChatBtn = document.getElementById('newChatBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');

    // Health ping (optional)
    fetch(HEALTH_URL, { mode: 'cors' }).then(() => {
      statusEl.textContent = 'Connected';
    }).catch(() => {
      statusEl.textContent = 'Connecting to API failed — check ?api=… or CORS.';
    });

    // -------- UI helpers --------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function addUserBubble(text) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-3 mb-4 justify-end';
      wrapper.innerHTML = `
        <div class="bg-indigo-600 text-white rounded-2xl px-4 py-3 shadow-sm max-w-[85%]">
          <p class="whitespace-pre-wrap"></p>
        </div>
        <div class="h-8 w-8 rounded-xl bg-indigo-600/10 border flex-shrink-0"></div>
      `;
      wrapper.querySelector('p').textContent = text;
      chatEl.appendChild(wrapper);
      chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
    }

    function addAssistantBubble(text) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-3 mb-4';
      wrapper.innerHTML = `
        <div class="h-8 w-8 rounded-xl bg-indigo-600 flex-shrink-0"></div>
        <div class="bg-white border rounded-2xl px-4 py-3 shadow-sm max-w-[85%]">
          <p class="whitespace-pre-wrap"></p>
        </div>
      `;
      wrapper.querySelector('p').textContent = text;
      chatEl.appendChild(wrapper);
      chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
    }

    function setTyping(on) {
      statusEl.textContent = on ? 'Corah is typing…' : '';
    }

    function disableInput(on) {
      inputEl.disabled = on;
      sendBtn.disabled = on;
    }

    function showBanner(text) {
      let banner = document.querySelector('.chat-banner');
      if (!banner) {
        banner = document.createElement('div');
        banner.className = 'chat-banner';
        banner.style.cssText = "margin:12px 0;padding:10px;border-radius:6px;font:14px/1.4 system-ui; background:#fff3cd; border:1px solid #ffe58f;";
        chatEl.appendChild(banner);
      }
      banner.textContent = text;
      chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
    }

    function handleEndSessionFlag(resp) {
      if (resp && resp.end_session) {
        disableInput(true);
        showBanner("Chat ended. Start a new chat to continue.");
        // Add a restart button once
        if (!document.getElementById('restart-chat-btn')) {
          const btn = document.createElement('button');
          btn.id = 'restart-chat-btn';
          btn.textContent = 'Start New Chat';
          btn.className = 'ml-2 px-3 py-1.5 rounded-lg border hover:bg-slate-50';
          btn.onclick = () => window.location.reload();
          document.querySelector('.chat-banner')?.appendChild(btn);
        }
        statusEl.textContent = 'Conversation closed. Start a new chat to continue.';
      }
    }

    // -------- Submit handler --------
    composerEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = inputEl.value.trim();
      if (!q) return;

      addUserBubble(q);
      inputEl.value = '';
      disableInput(true);
      setTyping(true);
      markUserActivity(); // reset local idle timer on send

      try {
        const res = await fetch(CHAT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            question: q,
          })
        });

        if (!res.ok) {
          const text = await res.text();
          addAssistantBubble('Hmm, I hit a snag talking to the server. Please try again.');
          console.error('API error', res.status, text);
        } else {
          const data = await res.json();
          addAssistantBubble(data.answer || '(no reply)');
          handleEndSessionFlag(data);
          if (data.end_session) {
            setTyping(false);
            return; // keep input disabled
          }
        }
      } catch (err) {
        console.error(err);
        addAssistantBubble('Network issue. Please check your connection and try again.');
      } finally {
        setTyping(false);
        if (!sendBtn.disabled) disableInput(false);
        inputEl.focus();
      }
    });

    // Enter to send; Shift+Enter for newline
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // New chat = fresh session id + clear UI
    newChatBtn.addEventListener('click', async () => {
      sessionId = (window.crypto?.randomUUID?.() || Math.random().toString(36).slice(2)).slice(0, 8);
      sessionId = 'web-' + sessionId;
      localStorage.setItem('corah_session_id', sessionId);
      chatEl.innerHTML = '';
      addAssistantBubble('New chat started. How can I help?');
      inputEl.disabled = false;
      sendBtn.disabled = false;
      statusEl.textContent = '';
      inputEl.focus();
      lastUserActionAt = Date.now();
      frontendWarned = false;
      removeBanner();
    });

    function removeBanner() {
      const b = document.querySelector('.chat-banner');
      if (b) b.remove();
    }

    // Copy shareable link (includes your API base if set)
    copyLinkBtn.addEventListener('click', async () => {
      const share = location.origin + location.pathname + (API_BASE ? `?api=${encodeURIComponent(API_BASE)}` : '');
      await navigator.clipboard.writeText(share);
      statusEl.textContent = 'Share link copied!';
      await sleep(1500);
      statusEl.textContent = '';
    });

    // Quick focus shortcut
    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== inputEl) {
        e.preventDefault();
        inputEl.focus();
      }
    });

    // -------- Inactivity: frontend banner (80% of timeout) --------
    let lastUserActionAt = Date.now();
    let frontendWarned = false;

    function markUserActivity() {
      lastUserActionAt = Date.now();
      if (frontendWarned) {
        removeBanner();
        frontendWarned = false;
      }
    }

    ['keydown','click','input'].forEach(evt => {
      inputEl.addEventListener(evt, markUserActivity);
    });

    setInterval(() => {
      const idleMin = (Date.now() - lastUserActionAt) / 60000;
      if (!frontendWarned && idleMin >= FRONTEND_WARN_AT_MIN) {
        showBanner("I haven’t heard back in a while — I’ll close this chat soon if there’s no reply.");
        frontendWarned = true;
      }
    }, 30000);

    // -------- Backend heartbeat: warn/close definitively --------
    async function heartbeat() {
      try {
        const res = await fetch(`${PING_URL}?session_id=${encodeURIComponent(sessionId)}`, { mode: 'cors' });
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.answer) {
          // Server may send a warning or closing line as an assistant turn
          addAssistantBubble(data.answer);
        }
        handleEndSessionFlag(data);
      } catch (e) {
        // silent fail is OK for heartbeat
      }
    }
    setInterval(heartbeat, 60000); // every 60s

  </script>
</body>
</html>